"""
Streamlit Stock Analysis App
Educational stock analysis tool with technical indicators and Monte Carlo simulation.
"""
import streamlit as st
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np
from datetime import datetime

from data_fetcher import DataFetcher
from indicators import TechnicalIndicators
from scoring import ScoringSystem
from monte_carlo import MonteCarloSimulator
from news_sentiment import NewsSentimentAnalyzer
from fundamentals import FundamentalAnalyzer


# Page configuration
st.set_page_config(
    page_title="Stock Analysis Tool",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 1rem;
    }
    .warning-box {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 5px;
        padding: 1rem;
        margin: 1rem 0;
        color: #000000;
    }
    .signal-buy {
        color: #28a745;
        font-weight: bold;
        font-size: 1.5rem;
    }
    .signal-sell {
        color: #dc3545;
        font-weight: bold;
        font-size: 1.5rem;
    }
    .signal-hold {
        color: #ffc107;
        font-weight: bold;
        font-size: 1.5rem;
    }
    .metric-card {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 1rem;
        margin: 0.5rem 0;
    }
    /* Remove box around info icon popover */
    button[kind="secondary"] {
        border: none !important;
        background: none !important;
        padding: 0 !important;
        box-shadow: none !important;
    }
    button[kind="secondary"]:hover {
        background: none !important;
        border: none !important;
    }
</style>
""", unsafe_allow_html=True)


def show_disclaimer():
    """Display disclaimer and risk acceptance."""
    if 'disclaimer_accepted' not in st.session_state:
        st.session_state.disclaimer_accepted = False
    
    if not st.session_state.disclaimer_accepted:
        st.markdown('<div class="main-header">‚ö†Ô∏è IMPORTANT DISCLAIMER</div>', unsafe_allow_html=True)
        
        st.markdown("""
        <div class="warning-box">
        <h3>üìã Educational Use Only</h3>
        
        This tool provides **EDUCATIONAL analysis only**.
        
        **‚ùå This is NOT:**
        - Financial advice
        - Investment recommendations
        - A guarantee of future performance
        
        **‚úÖ You should:**
        - Always do your own research
        - Consult a licensed financial advisor
        - Understand that trading involves significant risk of loss
        
        **‚ö†Ô∏è Important Notes:**
        - Past performance does NOT guarantee future results
        - You could lose all invested capital
        - The creators are NOT liable for any losses
        
        **By continuing, you acknowledge:**
        - ‚òê This is for educational purposes only
        - ‚òê I understand the risk of financial loss
        - ‚òê I will not hold creators liable for losses
        </div>
        """, unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns([1, 1, 1])
        with col2:
            if st.button("‚úÖ I Understand & Accept", type="primary", use_container_width=True):
                st.session_state.disclaimer_accepted = True
                st.rerun()
        
        st.stop()


def get_timeframe_days(timeframe: str) -> int:
    """Get number of days for Monte Carlo simulation based on timeframe."""
    timeframe_map = {
        "Short-term (1-7 days)": 7,
        "Medium-term (1-4 weeks)": 28,
        "Long-term (1-6 months)": 180
    }
    return timeframe_map.get(timeframe, 7)


def create_price_chart(data: pd.DataFrame, indicators: dict, stock_name: str):
    """Create interactive price chart with indicators."""
    fig = make_subplots(
        rows=4, cols=1,
        shared_xaxes=True,
        vertical_spacing=0.05,
        subplot_titles=(f'{stock_name} Price & Bollinger Bands', 'MACD', 'RSI', 'Volume'),
        row_heights=[0.5, 0.15, 0.15, 0.2]
    )
    
    # Price and Bollinger Bands
    fig.add_trace(
        go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name='Price'
        ),
        row=1, col=1
    )
    
    if 'bollinger' in indicators:
        bb = indicators['bollinger']
        fig.add_trace(
            go.Scatter(x=data.index, y=bb['upper_series'], name='BB Upper',
                      line=dict(color='gray', dash='dash')),
            row=1, col=1
        )
        fig.add_trace(
            go.Scatter(x=data.index, y=bb['middle_series'], name='BB Middle',
                      line=dict(color='orange')),
            row=1, col=1
        )
        fig.add_trace(
            go.Scatter(x=data.index, y=bb['lower_series'], name='BB Lower',
                      line=dict(color='gray', dash='dash')),
            row=1, col=1
        )
    
    # SMAs
    if 'sma' in indicators:
        sma = indicators['sma']
        if sma['sma_50'] is not None:
            fig.add_trace(
                go.Scatter(x=data.index, y=sma['sma_50_series'], name='SMA 50',
                          line=dict(color='blue')),
                row=1, col=1
            )
        if sma['sma_200'] is not None:
            fig.add_trace(
                go.Scatter(x=data.index, y=sma['sma_200_series'], name='SMA 200',
                          line=dict(color='red')),
                row=1, col=1
            )
    
    # MACD
    if 'macd' in indicators:
        macd = indicators['macd']
        fig.add_trace(
            go.Scatter(x=data.index, y=macd['macd_series'], name='MACD',
                      line=dict(color='blue')),
            row=2, col=1
        )
        fig.add_trace(
            go.Scatter(x=data.index, y=macd['signal_series'], name='Signal',
                      line=dict(color='red')),
            row=2, col=1
        )
        fig.add_trace(
            go.Bar(x=data.index, y=macd['histogram_series'], name='Histogram',
                  marker_color='gray'),
            row=2, col=1
        )
    
    # RSI
    if 'rsi' in indicators:
        rsi = indicators['rsi']
        fig.add_trace(
            go.Scatter(x=data.index, y=rsi['series'], name='RSI',
                      line=dict(color='purple')),
            row=3, col=1
        )
        fig.add_hline(y=70, line_dash="dash", line_color="red", row=3, col=1)
        fig.add_hline(y=30, line_dash="dash", line_color="green", row=3, col=1)
    
    # Volume
    if 'volume' in indicators:
        colors = ['red' if data['Close'].iloc[i] < data['Open'].iloc[i] else 'green' 
                 for i in range(len(data))]
        fig.add_trace(
            go.Bar(x=data.index, y=data['Volume'], name='Volume',
                  marker_color=colors),
            row=4, col=1
        )
    
    fig.update_layout(
        height=1000,
        showlegend=True,
        xaxis_rangeslider_visible=False,
        hovermode='x unified'
    )
    
    fig.update_xaxes(title_text="Date", row=4, col=1)
    fig.update_yaxes(title_text="Price ($)", row=1, col=1)
    fig.update_yaxes(title_text="MACD", row=2, col=1)
    fig.update_yaxes(title_text="RSI", row=3, col=1)
    fig.update_yaxes(title_text="Volume", row=4, col=1)
    
    return fig


def create_monte_carlo_chart(simulation_results: dict):
    """Create Monte Carlo simulation visualization."""
    simulations = simulation_results['simulations']
    days = simulation_results['days']
    current_price = simulation_results['current_price']
    
    fig = go.Figure()
    
    # Plot subset of simulations (for performance)
    sample_size = min(100, len(simulations))
    indices = np.random.choice(len(simulations), sample_size, replace=False)
    
    for idx in indices:
        fig.add_trace(
            go.Scatter(
                x=list(range(days)),
                y=simulations[idx],
                mode='lines',
                line=dict(color='lightblue', width=0.5),
                showlegend=False,
                opacity=0.3
            )
        )
    
    # Add median line
    median_path = np.median(simulations, axis=0)
    fig.add_trace(
        go.Scatter(
            x=list(range(days)),
            y=median_path,
            mode='lines',
            name='Median',
            line=dict(color='blue', width=3)
        )
    )
    
    # Add starting price
    fig.add_hline(y=current_price, line_dash="dash", line_color="black",
                  annotation_text=f"Current: ${current_price:.2f}")
    
    fig.update_layout(
        title="Monte Carlo Simulation (1000 iterations)",
        xaxis_title="Days",
        yaxis_title="Price ($)",
        height=500,
        hovermode='x unified'
    )
    
    return fig


def generate_signal_reasoning(score_results: dict, indicators: dict, stock_info: dict) -> str:
    """Generate detailed reasoning for the trading signal."""
    signal = score_results['signal']
    score = score_results['score']
    breakdown = score_results['breakdown']
    
    reasoning = f"### üß† Signal Reasoning\n\n"
    reasoning += f"**Overall Score: {score}/100** ({score_results['confidence']} confidence)\n\n"
    
    # Explain score calculation
    reasoning += "#### üìä Score Breakdown\n\n"
    reasoning += "Each indicator contributes to the total score based on its importance for your selected timeframe:\n\n"
    
    for indicator_name, details in breakdown.items():
        weighted = details['weighted']
        max_score = details['max']
        percentage = (weighted / max_score * 100) if max_score > 0 else 0
        reasoning += f"**{indicator_name.upper()}:** {weighted:.0f}/{max_score} points ({percentage:.0f}% efficiency)\n"
    
    reasoning += f"\n**Total:** {score}/100\n\n"
    
    # Count bullish vs bearish signals
    bullish_count = 0
    bearish_count = 0
    neutral_count = 0
    
    for ind_name, ind_data in indicators.items():
        if 'signal' in ind_data:
            sig = ind_data['signal']
            if 'BULLISH' in sig or 'ABOVE' in sig or 'HIGH VOLUME' in sig:
                bullish_count += 1
            elif 'BEARISH' in sig or 'BELOW' in sig or 'LOW VOLUME' in sig:
                bearish_count += 1
            else:
                neutral_count += 1
    
    total_signals = bullish_count + bearish_count + neutral_count
    
    reasoning += "---\n\n"
    reasoning += f"#### üéØ Why **{signal}**?\n\n"
    reasoning += f"**Market Consensus:** {bullish_count} bullish / {bearish_count} bearish / {neutral_count} neutral signals\n\n"
    
    if "BUY" in signal:
        reasoning += "**‚úÖ Strong Buy Case:**\n\n"
        reasoning += f"The score of {score}/100 indicates a favorable risk/reward setup. Here's why:\n\n"
        
        # Detailed indicator explanations
        if 'rsi' in indicators:
            rsi_val = indicators['rsi']['value']
            if rsi_val < 40:
                reasoning += f"**RSI ({rsi_val:.1f}):** Oversold territory suggests the stock has been sold off aggressively and may be due for a bounce. Historically, RSI below 40 often precedes short-term recoveries.\n\n"
            elif rsi_val < 60:
                reasoning += f"**RSI ({rsi_val:.1f}):** In neutral zone with room to run higher. Not showing overbought conditions, which means momentum can continue building.\n\n"
        
        if 'macd' in indicators and indicators['macd']['signal'] == 'BULLISH':
            reasoning += f"**MACD:** Bullish crossover detected (histogram: {indicators['macd']['histogram']:.2f}). This signals that short-term momentum is accelerating above the longer-term trend. When MACD crosses above its signal line, it often precedes price increases.\n\n"
        
        if 'bollinger' in indicators:
            bb_sig = indicators['bollinger']['signal']
            if 'LOWER' in bb_sig:
                reasoning += f"**Bollinger Bands:** Price near lower band (${indicators['bollinger']['lower']:.2f}). Statistically, prices tend to revert to the middle band (${indicators['bollinger']['middle']:.2f}), suggesting potential upside of {((indicators['bollinger']['middle'] - stock_info['current_price']) / stock_info['current_price'] * 100):.1f}%.\n\n"
            elif 'ABOVE' in bb_sig:
                reasoning += f"**Bollinger Bands:** Price above middle band shows bullish momentum. Current trend is upward.\n\n"
        
        if 'volume' in indicators and 'HIGH' in indicators['volume']['signal']:
            reasoning += f"**Volume:** {indicators['volume']['change_pct']:+.1f}% above average. High volume confirms genuine buying interest and validates the move. This isn't a low-conviction rally.\n\n"
        
        reasoning += f"**üìà Bottom Line:** With {bullish_count}/{total_signals} indicators bullish and a score above threshold, the technical setup favors entry at current levels.\n"
        
    elif "SELL" in signal:
        reasoning += "**‚ö†Ô∏è Warning Signs:**\n\n"
        reasoning += f"The score of {score}/100 is below safe thresholds. Here's why this is risky:\n\n"
        
        if 'rsi' in indicators and indicators['rsi']['value'] > 70:
            reasoning += f"**RSI ({indicators['rsi']['value']:.1f}):** Severely overbought. When RSI exceeds 70, it indicates excessive buying that typically leads to pullbacks. The stock is statistically \"expensive\" at current levels.\n\n"
        
        if 'macd' in indicators and indicators['macd']['signal'] == 'BEARISH':
            reasoning += f"**MACD:** Bearish crossover (histogram: {indicators['macd']['histogram']:.2f}). Momentum has turned negative. Short-term trend is now weaker than long-term, signaling potential decline.\n\n"
        
        if 'sma' in indicators and 'BEARISH' in indicators['sma']['signal']:
            reasoning += f"**Moving Averages:** Price below key support levels. This confirms downtrend. Breaking below moving averages often triggers further selling.\n\n"
        
        if 'volume' in indicators and 'LOW' in indicators['volume']['signal']:
            reasoning += f"**Volume:** {indicators['volume']['change_pct']:.1f}% below average. Low volume during price moves suggests weak conviction and potential reversal.\n\n"
        
        reasoning += f"**üìâ Bottom Line:** With {bearish_count}/{total_signals} bearish signals and score below {score}, risk significantly outweighs potential reward. Better opportunities elsewhere.\n"
        
    else:  # HOLD
        reasoning += "**‚è∏Ô∏è Mixed Signals - No Clear Edge:**\n\n"
        reasoning += f"The score of {score}/100 falls in the neutral zone. Here's the dilemma:\n\n"
        
        reasoning += f"**Bullish factors ({bullish_count}):**\n"
        if 'macd' in indicators and 'BULLISH' in indicators['macd']['signal']:
            reasoning += f"- MACD showing positive momentum\n"
        if 'volume' in indicators and 'HIGH' in indicators['volume']['signal']:
            reasoning += f"- Strong volume confirms participation\n"
        if 'bollinger' in indicators and 'ABOVE' in indicators['bollinger']['signal']:
            reasoning += f"- Price above middle Bollinger Band\n"
        
        reasoning += f"\n**Bearish/Neutral factors ({bearish_count + neutral_count}):**\n"
        if 'rsi' in indicators and 40 <= indicators['rsi']['value'] <= 60:
            reasoning += f"- RSI neutral (~{indicators['rsi']['value']:.0f}) - no clear bias\n"
        if 'sma' in indicators and 'INSUFFICIENT' in indicators['sma']['signal']:
            reasoning += f"- Trend unclear (insufficient data)\n"
        
        reasoning += f"\n**‚öñÔ∏è Bottom Line:** Not enough bullish confirmation to justify entry, but not bearish enough to avoid completely. Wait for {score + 10}-{score + 15} score (clearer setup) or {score - 10}-{score - 15} (clear avoidance). Patience beats forcing trades.\n"
    
    return reasoning


def generate_bull_reasoning(scenarios: dict, indicators: dict) -> str:
    """Generate reasoning for bull case."""
    bull = scenarios['bull']
    bear = scenarios['bear']
    
    is_more_likely = bull['probability'] > bear['probability']
    
    reasoning = f"### üü¢ Bull Case Analysis\n\n"
    
    # Adjust tone based on probability
    if is_more_likely:
        reasoning += f"**Probability: {bull['probability']:.1f}%** (More likely scenario)\n"
        reasoning += f"**Upside Target:** ${bull['target']:.2f} ({bull['change_pct']:+.1f}%)\n\n"
        reasoning += "üìà **Why this scenario is favored:**\n\n"
    else:
        reasoning += f"**Probability: {bull['probability']:.1f}%** (Less likely, but possible)\n"
        reasoning += f"**Upside Target:** ${bull['target']:.2f} ({bull['change_pct']:+.1f}%)\n\n"
        reasoning += "üìä **What would need to happen:**\n\n"
    
    # Count bullish indicators
    bullish_count = 0
    bullish_factors = []
    
    if 'rsi' in indicators:
        rsi = indicators['rsi']['value']
        if rsi < 40:
            bullish_factors.append(f"**RSI Oversold ({rsi:.1f}):** Significant bounce potential from oversold levels. Historically, RSI below 40 sees reversals within 1-5 days in ~65% of cases.")
            bullish_count += 1
        elif rsi < 55:
            bullish_factors.append(f"**RSI Neutral ({rsi:.1f}):** Room to appreciate without hitting overbought resistance at 70. Can sustain upward momentum.")
            bullish_count += 1
    
    if 'macd' in indicators and indicators['macd']['signal'] == 'BULLISH':
        bullish_factors.append(f"**MACD Crossover:** Bullish momentum confirmed. Histogram at {indicators['macd']['histogram']:.2f} shows acceleration. Short-term trend now outpacing long-term, which typically continues for 3-7 days.")
        bullish_count += 1
    
    if 'bollinger' in indicators:
        bb = indicators['bollinger']
        if 'LOWER' in bb['signal']:
            potential = ((bb['middle'] - bb['current']) / bb['current'] * 100)
            bullish_factors.append(f"**Bollinger Band Reversion:** Price near lower band (${bb['lower']:.2f}). Mean reversion to middle band (${bb['middle']:.2f}) would yield {potential:.1f}% gain. Statistically, 70% of touches revert.")
            bullish_count += 1
        elif 'ABOVE' in bb['signal']:
            bullish_factors.append(f"**Bollinger Bands:** Price above middle confirms uptrend. Bulls in control.")
            bullish_count += 1
    
    if 'sma' in indicators and 'BULLISH' in indicators['sma']['signal']:
        bullish_factors.append(f"**Moving Average Support:** Price trading above SMA 50 (${indicators['sma']['sma_50']:.2f}). This acts as support level and confirms trend direction.")
        bullish_count += 1
    
    if 'volume' in indicators and 'HIGH' in indicators['volume']['signal']:
        bullish_factors.append(f"**Volume Confirmation:** {indicators['volume']['change_pct']:+.1f}% above average. Institutional buying or retail FOMO supports sustainable move, not just noise.")
        bullish_count += 1
    
    # Add factors
    for i, factor in enumerate(bullish_factors, 1):
        reasoning += f"{i}. {factor}\n\n"
    
    if not bullish_factors:
        reasoning += "*No strong bullish catalysts detected currently. This scenario relies on external factors (news, sector rotation, market sentiment shift) rather than technical setup.*\n\n"
    
    # Conclusion based on probability
    reasoning += "---\n\n"
    if is_more_likely:
        reasoning += f"**‚úÖ Verdict:** {bullish_count}/5 technical factors support upside. Monte Carlo simulation ({bull['probability']:.1f}% probability) confirms this as the **primary scenario**. "
        if bull['change_pct'] > 2:
            reasoning += f"Target of {bull['change_pct']:+.1f}% offers solid risk/reward."
        else:
            reasoning += f"Modest {bull['change_pct']:+.1f}% target suggests limited upside - manage expectations."
    else:
        reasoning += f"**‚ö†Ô∏è Verdict:** Only {bullish_count}/5 factors support upside. {bull['probability']:.1f}% probability makes this the **secondary scenario**. While possible, "
        reasoning += f"the odds favor the bear case. Would need stronger confirmation (more bullish signals) to justify betting on this outcome."
    
    reasoning += f"\n\n*{bull['description']}*\n"
    
    return reasoning


def generate_bear_reasoning(scenarios: dict, indicators: dict) -> str:
    """Generate reasoning for bear case."""
    bear = scenarios['bear']
    bull = scenarios['bull']
    
    is_more_likely = bear['probability'] > bull['probability']
    
    reasoning = f"### üî¥ Bear Case Analysis\n\n"
    
    # Adjust tone based on probability
    if is_more_likely:
        reasoning += f"**Probability: {bear['probability']:.1f}%** (More likely scenario)\n"
        reasoning += f"**Downside Risk:** ${bear['target']:.2f} ({bear['change_pct']:.1f}%)\n\n"
        reasoning += "üìâ **Why this scenario is favored:**\n\n"
    else:
        reasoning += f"**Probability: {bear['probability']:.1f}%** (Less likely, but still a risk)\n"
        reasoning += f"**Downside Risk:** ${bear['target']:.2f} ({bear['change_pct']:.1f}%)\n\n"
        reasoning += "‚ö†Ô∏è **Risk factors to monitor:**\n\n"
    
    # Count bearish indicators
    bearish_count = 0
    bearish_factors = []
    
    if 'rsi' in indicators:
        rsi = indicators['rsi']['value']
        if rsi > 70:
            bearish_factors.append(f"**RSI Overbought ({rsi:.1f}):** Extreme overbought. RSI above 70 typically precedes 2-5% pullbacks within days. Stock is statistically \"expensive\" and due for mean reversion.")
            bearish_count += 1
        elif rsi > 60:
            bearish_factors.append(f"**RSI Elevated ({rsi:.1f}):** Approaching overbought zone. Limited room to run before hitting resistance at 70. Any negative catalyst could trigger selling.")
            bearish_count += 1
    
    if 'macd' in indicators and indicators['macd']['signal'] == 'BEARISH':
        bearish_factors.append(f"**MACD Bearish Crossover:** Momentum turned negative. Histogram at {indicators['macd']['histogram']:.2f} shows deceleration. Short-term trend now underperforming long-term - classic topping signal.")
        bearish_count += 1
    
    if 'bollinger' in indicators:
        bb = indicators['bollinger']
        if 'UPPER' in bb['signal']:
            potential_drop = ((bb['current'] - bb['middle']) / bb['current'] * 100)
            bearish_factors.append(f"**Bollinger Band Extension:** Price at upper band (${bb['upper']:.2f}). Mean reversion to middle (${bb['middle']:.2f}) would mean {potential_drop:.1f}% decline. Price has stretched too far from average.")
            bearish_count += 1
    
    if 'sma' in indicators and 'BEARISH' in indicators['sma']['signal']:
        bearish_factors.append(f"**Moving Average Breakdown:** Price below SMA 50 (${indicators['sma']['sma_50']:.2f}). Lost key support. Traders use this as stop-loss level, triggering cascading selling.")
        bearish_count += 1
    
    if 'volume' in indicators:
        vol = indicators['volume']
        if 'LOW' in vol['signal'] or vol['change_pct'] < -20:
            bearish_factors.append(f"**Volume Weakness:** {vol['change_pct']:.1f}% below average. Low conviction in current price. Moves without volume often reverse quickly.")
            bearish_count += 1
    
    # Add factors
    for i, factor in enumerate(bearish_factors, 1):
        reasoning += f"{i}. {factor}\n\n"
    
    if not bearish_factors:
        reasoning += "*No strong bearish signals detected. This scenario would require external shock (bad news, sector weakness, market crash) rather than technical deterioration.*\n\n"
    
    # Conclusion based on probability
    reasoning += "---\n\n"
    if is_more_likely:
        reasoning += f"**üö® Verdict:** {bearish_count}/5 technical factors point to downside risk. Monte Carlo simulation ({bear['probability']:.1f}% probability) confirms this as the **primary scenario**. "
        if abs(bear['change_pct']) > 2:
            reasoning += f"Potential {bear['change_pct']:.1f}% drop is significant - risk management critical."
        else:
            reasoning += f"Modest {bear['change_pct']:.1f}% downside, but still the more likely path."
        reasoning += " Consider waiting for better entry or tightening stop-losses."
    else:
        reasoning += f"**‚úÖ Verdict:** Only {bearish_count}/5 factors suggest downside. {bear['probability']:.1f}% probability makes this the **secondary scenario**. "
        reasoning += f"While risk exists, the odds favor the bull case. Monitor these factors but don't let fear override favorable setup. "
        reasoning += "Use stop-loss below key support to protect against this outcome."
    
    reasoning += f"\n\n*{bear['description']}*\n"
    
    return reasoning


def display_summary(stock_info: dict, score_results: dict, scenarios: dict, timeframe: str, indicators: dict):
    """Display summary view."""
    st.markdown("---")
    st.markdown('<div class="main-header">üìä ANALYSIS SUMMARY</div>', unsafe_allow_html=True)
    
    # Header with stock info
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown(f"### {stock_info['name']} ({stock_info.get('ticker', '')})")
    with col2:
        price_change = ((stock_info['current_price'] - stock_info['previous_close']) / 
                       stock_info['previous_close'] * 100)
        st.metric(
            "Current Price",
            f"${stock_info['current_price']:.2f}",
            f"{price_change:+.2f}%"
        )
    
    # Signal and score
    st.markdown("---")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        signal = score_results['signal']
        signal_class = "signal-buy" if "BUY" in signal else "signal-sell" if "SELL" in signal else "signal-hold"
        st.markdown(f'<div class="{signal_class}">üéØ {signal}</div>', unsafe_allow_html=True)
    
    with col2:
        st.metric("Score", f"{score_results['score']}/100")
    
    with col3:
        st.metric("Confidence", score_results['confidence'])
    
    st.markdown(f"**Timeframe:** {timeframe}")
    st.markdown(f"**Updated:** {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}")
    
    # NEW: "Why?" button for signal
    with st.expander("‚ùì **Why this signal?** (Click to see reasoning)", expanded=False):
        signal_reasoning = generate_signal_reasoning(score_results, indicators, stock_info)
        st.markdown(signal_reasoning)
    
    # Bull and Bear scenarios
    st.markdown("---")
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### üü¢ BULL CASE")
        bull = scenarios['bull']
        st.markdown(f"**Probability:** {bull['probability']:.1f}%")
        st.markdown(bull['description'])
        
        # NEW: "Why?" button for bull case
        with st.expander("‚ùì **Why bullish?**", expanded=False):
            bull_reasoning = generate_bull_reasoning(scenarios, indicators)
            st.markdown(bull_reasoning)
    
    with col2:
        st.markdown("### üî¥ BEAR CASE")
        bear = scenarios['bear']
        st.markdown(f"**Probability:** {bear['probability']:.1f}%")
        st.markdown(bear['description'])
        
        # NEW: "Why?" button for bear case
        with st.expander("‚ùì **Why bearish?**", expanded=False):
            bear_reasoning = generate_bear_reasoning(scenarios, indicators)
            st.markdown(bear_reasoning)


def display_detailed_analysis(indicators: dict, score_results: dict, stock_info: dict):
    """Display detailed technical analysis."""
    st.markdown("---")
    st.markdown("## üìà DETAILED TECHNICAL ANALYSIS")
    
    with st.expander("üìä Technical Indicators Breakdown", expanded=True):
        # RSI
        if 'rsi' in indicators:
            cols = st.columns([0.2, 3.5, 10])
            with cols[0]:
                with st.popover("‚ÑπÔ∏è", use_container_width=False):
                    st.markdown("""
                    **What is RSI?**
                    
                    The Relative Strength Index (RSI) measures the speed and magnitude of recent price changes to evaluate overbought or oversold conditions.
                    
                    **Range:** 0-100
                    - **< 30:** Oversold (may bounce up)
                    - **30-70:** Neutral zone
                    - **> 70:** Overbought (may pull back)
                    
                    **How to use:**
                    - RSI < 30 often signals buying opportunity
                    - RSI > 70 suggests caution (potential reversal)
                    - Divergences (price vs RSI) can predict reversals
                    """)
            with cols[1]:
                st.markdown("### RSI (Relative Strength Index)")
            
            rsi = indicators['rsi']
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("RSI Value", f"{rsi['value']:.1f}")
            with col2:
                st.metric("Signal", rsi['signal'])
            with col3:
                if 'rsi' in score_results['breakdown']:
                    st.metric("Score", f"{score_results['breakdown']['rsi']['weighted']:.0f}/{score_results['breakdown']['rsi']['max']}")
            
            # Interpretation
            if rsi['value'] < 30:
                st.info("üí° **Oversold** - Price may rebound. Historical rebounds from RSI<30 are common.")
            elif rsi['value'] > 70:
                st.warning("üí° **Overbought** - Price may pull back. Consider waiting for better entry.")
            
            st.markdown("---")
        
        # MACD
        if 'macd' in indicators:
            cols = st.columns([0.2, 5.8, 10])
            with cols[0]:
                with st.popover("‚ÑπÔ∏è", use_container_width=False):
                    st.markdown("""
                    **What is MACD?**
                    
                    MACD shows the relationship between two moving averages to identify momentum changes and trend direction.
                    
                    **Components:**
                    - **MACD Line:** 12-day EMA minus 26-day EMA
                    - **Signal Line:** 9-day EMA of MACD Line
                    - **Histogram:** MACD Line minus Signal Line
                    
                    **Signals:**
                    - **Golden Cross:** MACD crosses above Signal ‚Üí Bullish
                    - **Death Cross:** MACD crosses below Signal ‚Üí Bearish
                    - **Histogram widening:** Strengthening momentum
                    - **Histogram narrowing:** Weakening momentum
                    
                    **How to use:**
                    - Look for crossovers as entry/exit signals
                    - Histogram shows momentum strength
                    - Best combined with other indicators
                    """)
            with cols[1]:
                st.markdown("### MACD (Moving Average Convergence Divergence)")
            
            macd = indicators['macd']
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("MACD Line", f"{macd['macd_line']:.2f}")
            with col2:
                st.metric("Signal Line", f"{macd['signal_line']:.2f}")
            with col3:
                st.metric("Histogram", f"{macd['histogram']:.2f}")
            
            col1, col2 = st.columns(2)
            with col1:
                st.metric("Signal", macd['signal'])
            with col2:
                if 'macd' in score_results['breakdown']:
                    st.metric("Score", f"{score_results['breakdown']['macd']['weighted']:.0f}/{score_results['breakdown']['macd']['max']}")
            
            if macd['signal'] == "BULLISH":
                st.success("üí° MACD crossed above signal line - Momentum building upward.")
            elif macd['signal'] == "BEARISH":
                st.error("üí° MACD crossed below signal line - Momentum turning downward.")
            
            st.markdown("---")
        
        # Bollinger Bands
        if 'bollinger' in indicators:
            cols = st.columns([0.2, 2.2, 10])
            with cols[0]:
                with st.popover("‚ÑπÔ∏è", use_container_width=False):
                    st.markdown("""
                    **What are Bollinger Bands?**
                    
                    Bollinger Bands measure volatility and identify overbought/oversold conditions using standard deviations around a moving average.
                    
                    **Components:**
                    - **Middle Band:** 20-day Simple Moving Average (SMA)
                    - **Upper Band:** Middle + (2 √ó standard deviation)
                    - **Lower Band:** Middle - (2 √ó standard deviation)
                    
                    **Signals:**
                    - **Price at Upper Band:** Overbought (potential reversal down)
                    - **Price at Lower Band:** Oversold (potential bounce up)
                    - **Price above Middle:** Bullish trend
                    - **Price below Middle:** Bearish trend
                    - **Band Squeeze:** Low volatility, breakout coming
                    - **Band Expansion:** High volatility, trend in motion
                    
                    **Mean Reversion:**
                    When price touches a band, it often reverts back to the middle band (~70% of the time statistically).
                    """)
            with cols[1]:
                st.markdown("### Bollinger Bands")
            
            bb = indicators['bollinger']
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("Upper Band", f"${bb['upper']:.2f}")
            with col2:
                st.metric("Middle (SMA)", f"${bb['middle']:.2f}")
            with col3:
                st.metric("Lower Band", f"${bb['lower']:.2f}")
            with col4:
                st.metric("Current", f"${bb['current']:.2f}")
            
            col1, col2 = st.columns(2)
            with col1:
                st.metric("Signal", bb['signal'])
            with col2:
                if 'bollinger' in score_results['breakdown']:
                    st.metric("Score", f"{score_results['breakdown']['bollinger']['weighted']:.0f}/{score_results['breakdown']['bollinger']['max']}")
            
            st.markdown("---")
        
        # SMA
        if 'sma' in indicators:
            cols = st.columns([0.2, 3.8, 10])
            with cols[0]:
                with st.popover("‚ÑπÔ∏è", use_container_width=False):
                    st.markdown("""
                    **What are SMAs?**
                    
                    Simple Moving Averages smooth out price data to identify trend direction and support/resistance levels.
                    
                    **Common Periods:**
                    - **SMA 50:** Short-term trend (50 trading days ‚âà 2.5 months)
                    - **SMA 200:** Long-term trend (200 trading days ‚âà 10 months)
                    
                    **Signals:**
                    - **Price above SMA 50:** Short-term uptrend
                    - **Price below SMA 50:** Short-term downtrend
                    - **Price above SMA 200:** Long-term bull market
                    - **Price below SMA 200:** Long-term bear market
                    
                    **Golden Cross vs Death Cross:**
                    - **Golden Cross:** SMA 50 crosses above SMA 200 ‚Üí Very bullish
                    - **Death Cross:** SMA 50 crosses below SMA 200 ‚Üí Very bearish
                    
                    **Support/Resistance:**
                    SMAs often act as dynamic support (in uptrends) or resistance (in downtrends). Price bounces off them frequently.
                    """)
            with cols[1]:
                st.markdown("### Simple Moving Averages (SMA)")
            
            sma = indicators['sma']
            col1, col2, col3 = st.columns(3)
            with col1:
                if sma['sma_50']:
                    st.metric("SMA 50", f"${sma['sma_50']:.2f}")
            with col2:
                if sma['sma_200']:
                    st.metric("SMA 200", f"${sma['sma_200']:.2f}")
            with col3:
                st.metric("Current", f"${sma['current']:.2f}")
            
            col1, col2 = st.columns(2)
            with col1:
                st.metric("Signal", sma['signal'])
            with col2:
                if 'sma' in score_results['breakdown']:
                    st.metric("Score", f"{score_results['breakdown']['sma']['weighted']:.0f}/{score_results['breakdown']['sma']['max']}")
            
            st.markdown("---")
        
        # Volume
        if 'volume' in indicators:
            cols = st.columns([0.2, 2.4, 10])
            with cols[0]:
                with st.popover("‚ÑπÔ∏è", use_container_width=False):
                    st.markdown("""
                    **What is Volume?**
                    
                    Volume represents the total number of shares traded in a given period. It confirms the strength of price movements.
                    
                    **Key Concepts:**
                    - **High Volume:** Strong conviction, validates price moves
                    - **Low Volume:** Weak participation, moves may reverse
                    - **Volume Spike:** Unusual activity, often precedes major moves
                    
                    **Volume Patterns:**
                    - **Price up + Volume up:** Strong bullish confirmation
                    - **Price up + Volume down:** Weak rally, may fail
                    - **Price down + Volume up:** Strong selling pressure
                    - **Price down + Volume down:** Weak decline, may bounce
                    
                    **Why it matters:**
                    Volume confirms whether price movements are supported by real buying/selling or just noise. Without volume, price moves lack conviction.
                    
                    **Average Volume:**
                    Compared to 20-day average to identify unusual activity.
                    """)
            with cols[1]:
                st.markdown("### Volume Analysis")
            
            vol = indicators['volume']
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("Current Volume", f"{vol['current']:,.0f}")
            with col2:
                st.metric("Average Volume", f"{vol['average']:,.0f}")
            with col3:
                st.metric("Change", f"{vol['change_pct']:+.1f}%")
            
            col1, col2 = st.columns(2)
            with col1:
                st.metric("Signal", vol['signal'])
            with col2:
                if 'volume' in score_results['breakdown']:
                    st.metric("Score", f"{score_results['breakdown']['volume']['weighted']:.0f}/{score_results['breakdown']['volume']['max']}")


def main():
    """Main application."""
    # Show disclaimer first
    show_disclaimer()
    
    # App header
    st.markdown('<div class="main-header">üìä Stock Analysis Tool</div>', unsafe_allow_html=True)
    st.markdown('<p style="text-align: center; color: #666;">Educational stock analysis with technical indicators and Monte Carlo simulation</p>', unsafe_allow_html=True)
    
    # Sidebar inputs
    st.sidebar.header("‚öôÔ∏è Analysis Settings")
    
    ticker = st.sidebar.text_input("Stock Ticker", "AAPL", help="Enter stock symbol (e.g., AAPL, TSLA, NVDA)").upper()
    
    timeframe_options = ["Short-term (1-7 days)", "Medium-term (1-4 weeks)", "Long-term (1-6 months)"]
    timeframe_display = st.sidebar.selectbox("‚è±Ô∏è Trading Timeframe", timeframe_options)
    timeframe = timeframe_display.split()[0].lower()  # Extract 'short', 'medium', or 'long'
    
    risk_options = ["Conservative", "Moderate", "Aggressive"]
    risk_tolerance = st.sidebar.selectbox("üé≤ Risk Tolerance", risk_options).lower()
    
    analyze_button = st.sidebar.button("üîç Analyze Stock", type="primary", use_container_width=True)
    
    # Warning footer
    st.sidebar.markdown("---")
    st.sidebar.warning("‚ö†Ô∏è **Educational use only**\n\nNot financial advice")
    
    # Main analysis
    if analyze_button:
        if not ticker:
            st.error("Please enter a stock ticker symbol.")
            return
        
        with st.spinner(f"Analyzing {ticker}..."):
            # Fetch data
            fetcher = DataFetcher(ticker)
            
            # Validate ticker
            if not fetcher.validate_ticker():
                st.error(f"‚ùå Invalid ticker symbol: {ticker}")
                st.info("Please check the ticker and try again.")
                return
            
            # Get stock info
            stock_info = fetcher.get_stock_info()
            stock_info['ticker'] = ticker
            
            # Fetch historical data
            data = fetcher.fetch_data(timeframe)
            
            if data is None or data.empty:
                st.error(f"‚ùå Could not fetch data for {ticker}")
                return
            
            # Calculate indicators
            indicator_calc = TechnicalIndicators(data)
            indicators = indicator_calc.calculate_all()
            
            # Calculate score
            scorer = ScoringSystem(timeframe, risk_tolerance)
            score_results = scorer.calculate_score(indicators, stock_info)
            
            # Run Monte Carlo simulation
            days = get_timeframe_days(timeframe_display)
            mc_sim = MonteCarloSimulator(data)
            simulation_results = mc_sim.run_simulation(days, stock_info['current_price'])
            scenarios = mc_sim.get_scenarios(simulation_results)
            
            # Display results
            display_summary(stock_info, score_results, scenarios, timeframe_display, indicators)
            
            # Recommendation
            st.markdown("---")
            st.markdown("## üí° RECOMMENDATION")
            
            col1, col2 = st.columns([2, 1])
            with col1:
                signal = score_results['signal']
                
                if "BUY" in signal:
                    st.success(f"**Action:** {signal}")
                    st.write(f"**Entry Range:** ${stock_info['current_price'] * 0.99:.2f} - ${stock_info['current_price'] * 1.01:.2f}")
                    st.write(f"**Target:** ${scenarios['bull']['target']:.2f} ({scenarios['bull']['change_pct']:+.1f}%)")
                    st.write(f"**Stop-Loss:** ${stock_info['current_price'] * 0.97:.2f}")
                    
                    if risk_tolerance == "conservative":
                        st.write("**Position Size:** 2-3% of portfolio")
                    elif risk_tolerance == "aggressive":
                        st.write("**Position Size:** 7-10% of portfolio")
                    else:
                        st.write("**Position Size:** 3-5% of portfolio")
                    
                elif "SELL" in signal:
                    st.error(f"**Action:** {signal}")
                    st.write("Consider exiting position or avoiding entry at this time.")
                    
                else:  # HOLD
                    st.warning(f"**Action:** {signal}")
                    st.write("Wait for better entry opportunity or maintain current position.")
            
            with col2:
                risk_reward = abs(scenarios['bull']['change_pct'] / scenarios['bear']['change_pct']) if scenarios['bear']['change_pct'] != 0 else 0
                st.metric("Risk/Reward Ratio", f"1:{risk_reward:.1f}")
            
            # Charts
            st.markdown("---")
            st.markdown("## üìä INTERACTIVE CHARTS")
            
            tab1, tab2, tab3, tab4 = st.tabs(["Price & Indicators", "üìà Fundamentals", "üì∞ News & Sentiment", "Monte Carlo Simulation"])
            
            with tab1:
                price_chart = create_price_chart(data, indicators, stock_info['name'])
                st.plotly_chart(price_chart, use_container_width=True)
            
            with tab2:
                st.markdown("### üé≤ Monte Carlo Simulation Results")
                
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("Median Price", f"${simulation_results['median_price']:.2f}")
                with col2:
                    st.metric("Mean Price", f"${simulation_results['mean_price']:.2f}")
                with col3:
                    st.metric("10th Percentile", f"${simulation_results['percentile_10']:.2f}")
                with col4:
                    st.metric("90th Percentile", f"${simulation_results['percentile_90']:.2f}")
                
                mc_chart = create_monte_carlo_chart(simulation_results)
                st.plotly_chart(mc_chart, use_container_width=True)
                
                st.info(f"""
                **Simulation Parameters:**
                - Iterations: 1,000
                - Timeframe: {days} days
                - Daily Drift: {simulation_results['drift']*100:.3f}%
                - Daily Volatility: {simulation_results['volatility']*100:.2f}%
                """)
            
            with tab3:
                st.markdown("### üì∞ News & Sentiment Analysis")
                
                with st.spinner("Fetching latest news..."):
                    # Fetch and analyze news
                    news_analyzer = NewsSentimentAnalyzer(ticker)
                    news_data = news_analyzer.get_news_with_sentiment(limit=10)
                    
                    if 'error' in news_data:
                        st.warning(f"‚ö†Ô∏è {news_data['error']}")
                    else:
                        # Display overall sentiment
                        st.markdown("#### üìä Overall Sentiment")
                        overall = news_data['overall_sentiment']
                        
                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric(
                                "Sentiment",
                                f"{overall['emoji']} {overall['sentiment']}",
                                f"Score: {overall['compound']:.3f}"
                            )
                        with col2:
                            st.metric("üü¢ Positive", f"{overall['positive_count']}", 
                                     f"{overall['positive_count']/overall['total_count']*100:.0f}%")
                        with col3:
                            st.metric("üü° Neutral", f"{overall['neutral_count']}", 
                                     f"{overall['neutral_count']/overall['total_count']*100:.0f}%")
                        with col4:
                            st.metric("üî¥ Negative", f"{overall['negative_count']}", 
                                     f"{overall['negative_count']/overall['total_count']*100:.0f}%")
                        
                        # Sentiment interpretation
                        st.markdown("---")
                        if overall['sentiment'] == 'Positive':
                            st.success(f"""
                            **üìà Positive News Sentiment Detected**
                            
                            Recent news coverage is predominantly positive ({overall['positive_count']}/{overall['total_count']} articles).
                            This suggests favorable market perception and could support upward price momentum.
                            
                            **What this means:**
                            - Positive sentiment often correlates with buying interest
                            - Can act as a tailwind for technical setups
                            - Monitor for continuation or reversal in sentiment
                            """)
                        elif overall['sentiment'] == 'Negative':
                            st.error(f"""
                            **üìâ Negative News Sentiment Detected**
                            
                            Recent news coverage is predominantly negative ({overall['negative_count']}/{overall['total_count']} articles).
                            This suggests unfavorable market perception and could pressure prices downward.
                            
                            **What this means:**
                            - Negative sentiment often precedes or confirms downtrends
                            - Acts as headwind against bullish technical signals
                            - Consider waiting for sentiment improvement before entry
                            """)
                        else:
                            st.info(f"""
                            **‚öñÔ∏è Neutral News Sentiment**
                            
                            Recent news coverage is mixed or neutral. No clear sentiment bias detected.
                            
                            **What this means:**
                            - Sentiment is not a strong factor currently
                            - Rely more heavily on technical indicators
                            - Watch for sentiment shifts in either direction
                            """)
                        
                        # Display individual articles
                        st.markdown("---")
                        st.markdown("#### üì∞ Recent Articles")
                        
                        for i, article in enumerate(news_data['articles'], 1):
                            sentiment = article['sentiment']
                            
                            with st.expander(f"{sentiment['emoji']} {article['title']}", expanded=(i <= 3)):
                                col1, col2 = st.columns([3, 1])
                                
                                with col1:
                                    st.markdown(f"**Publisher:** {article['publisher']}")
                                    st.markdown(f"**Published:** {article['published_str']}")
                                    
                                    if article['link']:
                                        st.markdown(f"[Read full article ‚Üí]({article['link']})")
                                
                                with col2:
                                    st.metric("Sentiment", sentiment['sentiment'])
                                    st.metric("Score", f"{sentiment['compound']:.3f}")
                                
                                # Sentiment breakdown
                                st.markdown("**Sentiment Breakdown:**")
                                col1, col2, col3 = st.columns(3)
                                with col1:
                                    st.write(f"üü¢ Positive: {sentiment['positive']*100:.1f}%")
                                with col2:
                                    st.write(f"üü° Neutral: {sentiment['neutral']*100:.1f}%")
                                with col3:
                                    st.write(f"üî¥ Negative: {sentiment['negative']*100:.1f}%")
                        
                        # Disclaimer
                        st.markdown("---")
                        st.caption("""
                        **About Sentiment Analysis:**
                        Sentiment scores are generated using VADER (Valence Aware Dictionary and sEntiment Reasoner),
                        which analyzes the emotional tone of text. Scores range from -1 (most negative) to +1 (most positive).
                        
                        - **Positive:** Score ‚â• 0.05
                        - **Neutral:** -0.05 < Score < 0.05
                        - **Negative:** Score ‚â§ -0.05
                        
                        Sentiment analysis provides context but should be combined with technical analysis for trading decisions.
                        """)
            
            with tab4:
                st.markdown("### üìà Fundamental Analysis")
                st.markdown("**Long-term investment evaluation based on company fundamentals**")
                
                with st.spinner("Fetching fundamental data..."):
                    # Fetch fundamental data
                    fund_analyzer = FundamentalAnalyzer(ticker)
                    fundamentals = fund_analyzer.fetch_fundamentals()
                    health_score, analysis = fund_analyzer.calculate_health_score(fundamentals)
                    
                    # Overall Health Score
                    st.markdown("---")
                    st.markdown("#### üéØ Investment Health Score")
                    
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        # Color-coded score
                        if health_score >= 80:
                            score_color = "üü¢"
                            score_label = "Excellent"
                        elif health_score >= 60:
                            score_color = "üü°"
                            score_label = "Good"
                        elif health_score >= 40:
                            score_color = "üü†"
                            score_label = "Fair"
                        else:
                            score_color = "üî¥"
                            score_label = "Poor"
                        
                        st.metric("Overall Score", f"{score_color} {health_score}/100", score_label)
                    
                    with col2:
                        st.metric("Valuation", analysis['valuation_status'])
                    
                    with col3:
                        st.metric("Strengths Found", len(analysis['strengths']))
                    
                    # Strengths and Red Flags
                    st.markdown("---")
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.markdown("#### ‚úÖ Strengths")
                        if analysis['strengths']:
                            for strength in analysis['strengths']:
                                st.markdown(f"- {strength}")
                        else:
                            st.info("No significant strengths identified")
                    
                    with col2:
                        st.markdown("#### üö© Red Flags")
                        if analysis['red_flags']:
                            for flag in analysis['red_flags']:
                                st.markdown(f"- ‚ö†Ô∏è {flag}")
                        else:
                            st.success("No major red flags identified")
                    
                    # Valuation Metrics
                    st.markdown("---")
                    st.markdown("#### üí∞ Valuation Metrics")
                    
                    val = fundamentals['valuation']
                    col1, col2, col3, col4 = st.columns(4)
                    
                    with col1:
                        pe_trailing = val.get('pe_trailing')
                        if pe_trailing:
                            interpretation = fund_analyzer.get_metric_interpretation('pe_trailing', pe_trailing)
                            st.metric("P/E Ratio (Trailing)", f"{pe_trailing:.2f}", 
                                     help=f"Price-to-Earnings ratio. {interpretation}")
                        else:
                            st.metric("P/E Ratio (Trailing)", "N/A", help="Data not available")
                    
                    with col2:
                        pe_forward = val.get('pe_forward')
                        if pe_forward:
                            interpretation = fund_analyzer.get_metric_interpretation('pe_forward', pe_forward)
                            st.metric("P/E Ratio (Forward)", f"{pe_forward:.2f}",
                                     help=f"Forward P/E ratio. {interpretation}")
                        else:
                            st.metric("P/E Ratio (Forward)", "N/A", help="Data not available")
                    
                    with col3:
                        pb_ratio = val.get('pb_ratio')
                        if pb_ratio:
                            interpretation = fund_analyzer.get_metric_interpretation('pb_ratio', pb_ratio)
                            st.metric("P/B Ratio", f"{pb_ratio:.2f}",
                                     help=f"Price-to-Book ratio. {interpretation}")
                        else:
                            st.metric("P/B Ratio", "N/A", help="Data not available")
                    
                    with col4:
                        peg_ratio = val.get('peg_ratio')
                        if peg_ratio:
                            interpretation = fund_analyzer.get_metric_interpretation('peg_ratio', peg_ratio)
                            st.metric("PEG Ratio", f"{peg_ratio:.2f}",
                                     help=f"Price/Earnings-to-Growth ratio. {interpretation}")
                        else:
                            st.metric("PEG Ratio", "N/A", help="Data not available")
                    
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        market_cap = val.get('market_cap')
                        if market_cap:
                            if market_cap >= 1e12:
                                cap_str = f"${market_cap/1e12:.2f}T"
                            elif market_cap >= 1e9:
                                cap_str = f"${market_cap/1e9:.2f}B"
                            else:
                                cap_str = f"${market_cap/1e6:.2f}M"
                            st.metric("Market Cap", cap_str, help="Total market value of company")
                        else:
                            st.metric("Market Cap", "N/A")
                    
                    with col2:
                        ps_ratio = val.get('price_to_sales')
                        if ps_ratio:
                            st.metric("P/S Ratio", f"{ps_ratio:.2f}",
                                     help="Price-to-Sales ratio - lower is generally better")
                        else:
                            st.metric("P/S Ratio", "N/A")
                    
                    # Profitability Metrics
                    st.markdown("---")
                    st.markdown("#### üìä Profitability Metrics")
                    
                    prof = fundamentals['profitability']
                    col1, col2, col3, col4 = st.columns(4)
                    
                    with col1:
                        profit_margin = prof.get('profit_margin')
                        if profit_margin is not None:
                            interpretation = fund_analyzer.get_metric_interpretation('profit_margin', profit_margin)
                            color = "üü¢" if profit_margin > 0.1 else ("üü°" if profit_margin > 0 else "üî¥")
                            st.metric(f"{color} Profit Margin", f"{profit_margin*100:.2f}%",
                                     help=f"{interpretation}")
                        else:
                            st.metric("Profit Margin", "N/A")
                    
                    with col2:
                        operating_margin = prof.get('operating_margin')
                        if operating_margin is not None:
                            color = "üü¢" if operating_margin > 0.15 else ("üü°" if operating_margin > 0 else "üî¥")
                            st.metric(f"{color} Operating Margin", f"{operating_margin*100:.2f}%",
                                     help="Operating income as % of revenue")
                        else:
                            st.metric("Operating Margin", "N/A")
                    
                    with col3:
                        roe = prof.get('roe')
                        if roe is not None:
                            interpretation = fund_analyzer.get_metric_interpretation('roe', roe)
                            color = "üü¢" if roe > 0.15 else ("üü°" if roe > 0 else "üî¥")
                            st.metric(f"{color} ROE", f"{roe*100:.2f}%",
                                     help=f"Return on Equity. {interpretation}")
                        else:
                            st.metric("ROE", "N/A")
                    
                    with col4:
                        roa = prof.get('roa')
                        if roa is not None:
                            color = "üü¢" if roa > 0.05 else ("üü°" if roa > 0 else "üî¥")
                            st.metric(f"{color} ROA", f"{roa*100:.2f}%",
                                     help="Return on Assets - how efficiently company uses assets")
                        else:
                            st.metric("ROA", "N/A")
                    
                    # Growth Metrics
                    st.markdown("---")
                    st.markdown("#### üöÄ Growth Metrics")
                    
                    growth = fundamentals['growth']
                    col1, col2, col3, col4 = st.columns(4)
                    
                    with col1:
                        revenue_growth = growth.get('revenue_growth')
                        if revenue_growth is not None:
                            color = "üü¢" if revenue_growth > 0.15 else ("üü°" if revenue_growth > 0 else "üî¥")
                            st.metric(f"{color} Revenue Growth", f"{revenue_growth*100:.2f}%",
                                     help="Year-over-year revenue growth")
                        else:
                            st.metric("Revenue Growth", "N/A")
                    
                    with col2:
                        earnings_growth = growth.get('earnings_growth')
                        if earnings_growth is not None:
                            color = "üü¢" if earnings_growth > 0.15 else ("üü°" if earnings_growth > 0 else "üî¥")
                            st.metric(f"{color} Earnings Growth", f"{earnings_growth*100:.2f}%",
                                     help="Year-over-year earnings growth")
                        else:
                            st.metric("Earnings Growth", "N/A")
                    
                    with col3:
                        eps = growth.get('eps')
                        if eps is not None:
                            color = "üü¢" if eps > 0 else "üî¥"
                            st.metric(f"{color} EPS (Trailing)", f"${eps:.2f}",
                                     help="Earnings Per Share - profit per share")
                        else:
                            st.metric("EPS (Trailing)", "N/A")
                    
                    with col4:
                        eps_forward = growth.get('eps_forward')
                        if eps_forward is not None:
                            st.metric("EPS (Forward)", f"${eps_forward:.2f}",
                                     help="Expected future earnings per share")
                        else:
                            st.metric("EPS (Forward)", "N/A")
                    
                    # Financial Health Metrics
                    st.markdown("---")
                    st.markdown("#### üí™ Financial Health")
                    
                    health = fundamentals['financial_health']
                    col1, col2, col3, col4 = st.columns(4)
                    
                    with col1:
                        debt_to_equity = health.get('debt_to_equity')
                        if debt_to_equity is not None:
                            interpretation = fund_analyzer.get_metric_interpretation('debt_to_equity', debt_to_equity)
                            color = "üü¢" if debt_to_equity < 50 else ("üü°" if debt_to_equity < 100 else "üî¥")
                            st.metric(f"{color} Debt-to-Equity", f"{debt_to_equity:.1f}",
                                     help=f"{interpretation}")
                        else:
                            st.metric("Debt-to-Equity", "N/A")
                    
                    with col2:
                        current_ratio = health.get('current_ratio')
                        if current_ratio is not None:
                            interpretation = fund_analyzer.get_metric_interpretation('current_ratio', current_ratio)
                            color = "üü¢" if current_ratio > 1.5 else ("üü°" if current_ratio > 1 else "üî¥")
                            st.metric(f"{color} Current Ratio", f"{current_ratio:.2f}",
                                     help=f"{interpretation}")
                        else:
                            st.metric("Current Ratio", "N/A")
                    
                    with col3:
                        quick_ratio = health.get('quick_ratio')
                        if quick_ratio is not None:
                            color = "üü¢" if quick_ratio > 1 else "üî¥"
                            st.metric(f"{color} Quick Ratio", f"{quick_ratio:.2f}",
                                     help="Like current ratio but excludes inventory - tests immediate liquidity")
                        else:
                            st.metric("Quick Ratio", "N/A")
                    
                    with col4:
                        free_cash_flow = health.get('free_cash_flow')
                        if free_cash_flow is not None:
                            if free_cash_flow >= 1e9:
                                fcf_str = f"${free_cash_flow/1e9:.2f}B"
                            elif free_cash_flow >= 1e6:
                                fcf_str = f"${free_cash_flow/1e6:.2f}M"
                            else:
                                fcf_str = f"${free_cash_flow:,.0f}"
                            color = "üü¢" if free_cash_flow > 0 else "üî¥"
                            st.metric(f"{color} Free Cash Flow", fcf_str,
                                     help="Cash available after capital expenditures - crucial for growth")
                        else:
                            st.metric("Free Cash Flow", "N/A")
                    
                    # Dividend Metrics
                    st.markdown("---")
                    st.markdown("#### üíµ Dividend Information")
                    
                    div = fundamentals['dividends']
                    col1, col2, col3, col4 = st.columns(4)
                    
                    with col1:
                        dividend_yield = div.get('dividend_yield')
                        if dividend_yield and dividend_yield > 0:
                            interpretation = fund_analyzer.get_metric_interpretation('dividend_yield', dividend_yield)
                            st.metric("Dividend Yield", f"{dividend_yield*100:.2f}%",
                                     help=f"{interpretation}")
                        else:
                            st.metric("Dividend Yield", "None", help="Company does not pay dividends")
                    
                    with col2:
                        payout_ratio = div.get('payout_ratio')
                        if payout_ratio is not None:
                            color = "üü¢" if 0 < payout_ratio < 0.6 else ("üü°" if payout_ratio < 0.8 else "üî¥")
                            st.metric(f"{color} Payout Ratio", f"{payout_ratio*100:.1f}%",
                                     help="% of earnings paid as dividends - lower is more sustainable")
                        else:
                            st.metric("Payout Ratio", "N/A")
                    
                    with col3:
                        ex_dividend_date = div.get('ex_dividend_date')
                        if ex_dividend_date:
                            st.metric("Ex-Dividend Date", ex_dividend_date,
                                     help="Last date to buy stock and receive next dividend")
                        else:
                            st.metric("Ex-Dividend Date", "N/A")
                    
                    with col4:
                        dividend_rate = div.get('dividend_rate')
                        if dividend_rate:
                            st.metric("Annual Dividend", f"${dividend_rate:.2f}",
                                     help="Total annual dividend per share")
                        else:
                            st.metric("Annual Dividend", "N/A")
                    
                    # Other Important Metrics
                    st.markdown("---")
                    st.markdown("#### üìÖ Other Important Metrics")
                    
                    other = fundamentals['other']
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        beta = other.get('beta')
                        if beta is not None:
                            interpretation = fund_analyzer.get_metric_interpretation('beta', beta)
                            st.metric("Beta (Volatility)", f"{beta:.2f}",
                                     help=f"{interpretation}")
                        else:
                            st.metric("Beta", "N/A")
                    
                    with col2:
                        earnings_date = other.get('earnings_date')
                        if earnings_date:
                            st.metric("Next Earnings", earnings_date,
                                     help="Next earnings report date - expect volatility")
                        else:
                            st.metric("Next Earnings", "N/A")
                    
                    with col3:
                        high_52 = other.get('fifty_two_week_high')
                        low_52 = other.get('fifty_two_week_low')
                        if high_52 and low_52:
                            st.metric("52-Week Range", f"${low_52:.2f} - ${high_52:.2f}",
                                     help="Stock's trading range over past year")
                        else:
                            st.metric("52-Week Range", "N/A")
                    
                    # Investment Insights
                    st.markdown("---")
                    st.markdown("#### üí° Long-Term Investment Insights")
                    
                    if health_score >= 70:
                        st.success(f"""
                        **Strong Fundamental Profile (Score: {health_score}/100)**
                        
                        This company shows solid fundamentals for long-term investment consideration:
                        
                        **Key Positives:**
                        {chr(10).join('- ' + s for s in analysis['strengths'][:5]) if analysis['strengths'] else '- Multiple positive indicators'}
                        
                        **Valuation Status:** {analysis['valuation_status']}
                        
                        **Investment Strategy:**
                        - Suitable for buy-and-hold approach
                        - Consider dollar-cost averaging for entry
                        - Monitor quarterly earnings for changes
                        - Review fundamentals annually
                        """)
                    elif health_score >= 50:
                        st.info(f"""
                        **Moderate Fundamental Profile (Score: {health_score}/100)**
                        
                        This company shows mixed fundamentals. Suitable for investors with moderate risk tolerance.
                        
                        **Valuation Status:** {analysis['valuation_status']}
                        
                        **Areas of Concern:**
                        {chr(10).join('- ' + f for f in analysis['red_flags'][:3]) if analysis['red_flags'] else '- Some metrics need improvement'}
                        
                        **Investment Strategy:**
                        - Conduct deeper due diligence
                        - Compare with industry peers
                        - Watch for improving trends
                        - Consider smaller position size
                        """)
                    else:
                        st.warning(f"""
                        **Weak Fundamental Profile (Score: {health_score}/100)**
                        
                        This company shows concerning fundamentals. High-risk investment.
                        
                        **Major Red Flags:**
                        {chr(10).join('- ' + f for f in analysis['red_flags'][:5]) if analysis['red_flags'] else '- Multiple negative indicators'}
                        
                        **Valuation Status:** {analysis['valuation_status']}
                        
                        **Investment Strategy:**
                        - High risk - not suitable for conservative investors
                        - If considering, use very small position
                        - Focus on potential turnaround catalysts
                        - Set strict stop-losses
                        """)
                    
                    # Educational Content
                    st.markdown("---")
                    st.markdown("#### üìö Understanding Fundamental Analysis")
                    
                    with st.expander("What is Fundamental Analysis?"):
                        st.markdown("""
                        Fundamental analysis evaluates a company's intrinsic value by examining:
                        
                        1. **Financial Health** - Balance sheet strength, debt levels, liquidity
                        2. **Profitability** - How efficiently the company generates profits
                        3. **Growth Potential** - Revenue and earnings growth trajectory
                        4. **Valuation** - Whether the stock price is justified by fundamentals
                        5. **Market Position** - Competitive advantages and industry standing
                        
                        **For long-term investors**, fundamentals matter more than short-term price movements.
                        """)
                    
                    with st.expander("How to Use These Metrics"):
                        st.markdown("""
                        **Valuation Metrics** - Are you paying a fair price?
                        - P/E Ratio: Lower is generally cheaper (compare to industry average)
                        - PEG Ratio: Below 1 suggests undervalued growth
                        - P/B Ratio: Below 3 is typically reasonable
                        
                        **Profitability Metrics** - Is the business profitable?
                        - Profit Margin > 10%: Good
                        - ROE > 15%: Excellent returns to shareholders
                        - Operating Margin: Shows operational efficiency
                        
                        **Growth Metrics** - Is the company growing?
                        - Revenue Growth > 10%: Strong growth
                        - Positive EPS: Essential for profitability
                        - Compare to industry growth rates
                        
                        **Financial Health** - Can the company weather storms?
                        - Debt-to-Equity < 100: Healthy leverage
                        - Current Ratio > 1.5: Good liquidity
                        - Positive Free Cash Flow: Critical for sustainability
                        
                        **Combined Analysis**: Use fundamentals + technical analysis for best results!
                        """)
                    
                    with st.expander("Value vs Growth Investing"):
                        st.markdown("""
                        **Value Investing** (Warren Buffett style):
                        - Focus on low P/E, P/B ratios
                        - Strong free cash flow
                        - Dividend payments
                        - Proven track record
                        - Example metrics: P/E < 15, PEG < 1, Dividend Yield > 3%
                        
                        **Growth Investing** (Focus on expansion):
                        - High revenue/earnings growth
                        - Reinvestment over dividends
                        - Market leadership
                        - Innovation potential
                        - Example metrics: Revenue Growth > 20%, expanding margins
                        
                        **Your approach depends on your goals, timeline, and risk tolerance.**
                        """)
                    
                    # Disclaimer
                    st.markdown("---")
                    st.caption("""
                    **Fundamental Analysis Disclaimer:**
                    All data is sourced from yfinance and may have delays or inaccuracies. 
                    The Health Score is an educational tool and not investment advice. 
                    Always conduct your own thorough research and consult with a financial advisor.
                    Past performance does not guarantee future results.
                    """)
            
            # Detailed analysis
            display_detailed_analysis(indicators, score_results, stock_info)
    
    else:
        # Initial state - show instructions
        st.info("""
        ### üëã Welcome to the Stock Analysis Tool!
        
        **How to use:**
        1. Enter a stock ticker (e.g., AAPL, TSLA, NVDA)
        2. Select your trading timeframe
        3. Choose your risk tolerance
        4. Click "Analyze Stock"
        
        **What you'll get:**
        - Technical analysis with RSI, MACD, Bollinger Bands, SMA, and Volume
        - BUY/SELL/HOLD recommendation with confidence level
        - Bull and Bear scenarios with probabilities
        - Monte Carlo simulation (1000 iterations)
        - Interactive charts
        
        **Remember:** This is for educational purposes only. Always do your own research!
        """)


if __name__ == "__main__":
    main()
